AWSTemplateFormatVersion: 2010-09-09
Description: This template runs the nested infrastructure-* templates, and creates
  a VPC, and Application Load Balancer, and an ECS Cluster.
Parameters:
  KeyPairName:
    Description: Name of the SSH keypair, to allow to you to login to ECS cluster
      intances.
    Type: AWS::EC2::KeyPair::KeyName
Resources:
  ALBStack:
    Properties:
      Parameters:
        Name:
          Ref: AWS::StackName
        SubnetIDs:
          Fn::Join:
          - ','
          - - Fn::GetAtt:
              - VPCStack
              - Outputs.PublicSubnet1ID
            - Fn::GetAtt:
              - VPCStack
              - Outputs.PublicSubnet2ID
        VPCID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
      TemplateURL: https://s3.amazonaws.com/code-us-east-1-82573941361/prod/templates//929c1e5b6e650b12867e16cdd7f847fa.template
    Type: AWS::CloudFormation::Stack
  ECSStack:
    Properties:
      Parameters:
        KeyPairName:
          Ref: KeyPairName
        LoadBalancerSecurityGroupID:
          Fn::GetAtt:
          - ALBStack
          - Outputs.LoadBalancerSecurityGroupID
        SubnetIDs:
          Fn::Join:
          - ','
          - - Fn::GetAtt:
              - VPCStack
              - Outputs.PrivateSubnet1AID
            - Fn::GetAtt:
              - VPCStack
              - Outputs.PrivateSubnet2AID
        VPCID:
          Fn::GetAtt:
          - VPCStack
          - Outputs.VPCID
      TemplateURL: https://s3.amazonaws.com/code-us-east-1-82573941361/prod/templates//d911f94b8a96c115ee878d3605ddc57b.template
    Type: AWS::CloudFormation::Stack
  VPCStack:
    Properties:
      Parameters:
        AvailabilityZones:
          Fn::Join:
          - ','
          - - Fn::Select:
              - 0
              - Fn::GetAZs: ''
            - Fn::Select:
              - 1
              - Fn::GetAZs: ''
        CreatePrivateSubnets: 'true'
        KeyPairName:
          Ref: KeyPairName
        NATInstanceType: t2.micro
        NumberOfAZs: 2
      TemplateURL: https://s3.amazonaws.com/code-us-east-1-82573941361/prod/templates//2a3c93fb514ba5da092cc4670d223abb.template
    Type: AWS::CloudFormation::Stack
